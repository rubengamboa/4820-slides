<!DOCTYPE html>
<html>
<head>
  <title>COSC 4820 Database Systems</title>
  <meta charset="utf-8">
  <meta name="description" content="COSC 4820 Database Systems">
  <meta name="author" content="Ruben Gamboa">
  <meta name="generator" content="slidify" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <link rel="stylesheet" href="libraries/frameworks/io2012/css/default.css" media="all" >
  <link rel="stylesheet" href="libraries/frameworks/io2012/css/phone.css" 
    media="only screen and (max-device-width: 480px)" >
  <link rel="stylesheet" href="libraries/frameworks/io2012/css/slidify.css" >
  <link rel="stylesheet" href="libraries/highlighters/highlight.js/css/tomorrow.css" />
  <base target="_blank"> <!-- This amazingness opens all links in a new tab. -->  <link rel=stylesheet href="libraries/widgets/bootstrap/css/bootstrap.css"></link>
<link rel=stylesheet href="./assets/css/ribbons.css"></link>

  
  <!-- Grab CDN jQuery, fall back to local if offline -->
  <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.7.min.js"></script>
  <script>window.jQuery || document.write('<script src="libraries/widgets/quiz/js/jquery.js"><\/script>')</script> 
  <script data-main="libraries/frameworks/io2012/js/slides" 
    src="libraries/frameworks/io2012/js/require-1.0.8.min.js">
  </script>
  
  

</head>
<body style="opacity: 0">
  <slides class="layout-widescreen">
    
    <!-- LOGO SLIDE -->
        <slide class="title-slide segue nobackground">
  <hgroup class="auto-fadein">
    <h1>COSC 4820 Database Systems</h1>
    <h2>SQL in a Server Environment</h2>
    <p>Ruben Gamboa<br/>Associate Professor</p>
  </hgroup>
  <article></article>  
</slide>
    

    <!-- SLIDES -->
    <slide class="" id="slide-1" style="background:;">
  <article data-timings="">
    <style>
.title-slide {
     background-color: #EDE0CF; /* CBE7A5; #EDE0CF; ; #CA9F9D*/
     background-image: url(assets/img/uw-logo-large.png);
     background-repeat: no-repeat;
     background-position: center top;
   }
</style>

<h2>Chapter Overview</h2>

<ul>
<li>This chapter is about programming <strong>database applications</strong></li>
<li>We will begin with the model for client/server computing and how this is really done in modern systems (i.e., the web)</li>
<li>We will also discuss different ways that a program can interact with a database</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-2" style="background:;">
  <hgroup>
    <h1>The Three-Tier Architecture</h1>
  </hgroup>
  <article data-timings="">
    
  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-3" style="background:;">
  <hgroup>
    <h2>The Three-Tier Architecture</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>This is the dominant architecture for modern enterprise systems</li>
</ul>

<ol>
<li><strong>Web servers</strong> create a layer for humans to interact with the system</li>
<li><strong>Application servers</strong> perform the actual business logic of the application

<ul>
<li>These may be provided strictly to the web servers</li>
<li>They man also be available to <strong>other programs</strong> via <strong>web services</strong></li>
</ul></li>
<li><strong>Database servers</strong> perform queries and manipulate the data</li>
</ol>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-4" style="background:;">
  <hgroup>
    <h2>The Three-Tier Architecture</h2>
  </hgroup>
  <article data-timings="">
    <div class="centered">
    <img src="assets/img/three-tier-architecture.png" title="Three-Tier Architecture" alt="Three-Tier Architecture">
</div>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-5" style="background:;">
  <hgroup>
    <h2>The Web Server Tier</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>The web server is responsible for creating the <strong>view</strong> or user interface</li>
<li>This will consist of HTML, CSS, JavaScript, media files, etc.</li>
</ul>

<p><br></p>

<ul>
<li>User interaction will be in the way of <strong>requests</strong>, e.g., an filling out HTTP form or clicking on a link</li>
<li>The server with send <strong>responses</strong>, which may be new HTML pages or documents</li>
</ul>

<p><br></p>

<ul>
<li>Of course, the UI may be implemented in other ways</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-6" style="background:;">
  <hgroup>
    <h2>The Application Tier</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>This is responsible for handling user requests <strong>at the database level</strong></li>
<li>I.e., it does not care about the actual UI</li>
<li>It only cares about what the requests mean for the enterprise systems</li>
</ul>

<p><br></p>

<ul>
<li>In very simple systems, the application tier directly accesses the database</li>
<li>In more complex systems, there can be a very complicated network of objects or services,
and the application tier may have to <strong>integrate</strong> them</li>
<li>Different services may communicate with each other

<ul>
<li>synchronously</li>
<li>asynchronously</li>
<li>via messaging</li>
<li>indirectly, e.g., via the database</li>
</ul></li>
<li>There may even be a need to make transactions that span multiple services!</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-7" style="background:;">
  <hgroup>
    <h2>The Database Tier</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>This are services or classes that interact with the database</li>
<li>It is also known as the <strong>persistence layer</strong></li>
</ul>

<p><br></p>

<ul>
<li>Remember that connections to the database are expensive</li>
<li>Also, connections may take a long time to start up</li>
<li>These types of details are handled in the database tier, e.g., by <strong>connection pooling</strong></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-8" style="background:;">
  <hgroup>
    <h1>The SQL Environment</h1>
  </hgroup>
  <article data-timings="">
    
  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-9" style="background:;">
  <hgroup>
    <h2>The SQL Environment</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>A <strong>SQL Environment</strong> is a particular installation of a relational database that you can access</li>
<li>It may consist of one or more database <strong>instances</strong> running on one or more physical servers</li>
<li>The largest unit of information is a <strong>cluster</strong>, which corresponds to a &quot;database&quot;</li>
</ul>

<div class="centered">
    <img src="assets/img/sql-environment.png" title="SQL Environment" alt="SQL Environment">
</div>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-10" style="background:;">
  <hgroup>
    <h2>Components of a SQL Environment</h2>
  </hgroup>
  <article data-timings="">
    <ul class = "build incremental">
<li><strong>Schemas</strong> are collections of related tables, views, indexes, triggers, assertions, etc.

<ul>
<li>Schemas also have information about the tables, etc., that they contain
<br><br></li>
</ul></li>
<li><strong>Catalogs</strong> are collections of schemas, and they provide information on the schemas they manage
<br><br></li>
<li><strong>Clusters</strong> are collections of catalogs</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-11" style="background:;">
  <hgroup>
    <h2>Schemas</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>You can create a schema with <code>CREATE SCHEMA ...</code> command

<ul>
<li><code>CREATE SCHEMA MovieInformation</code></li>
</ul></li>
<li>A schema may also be associated with a particular user
<br><br></li>
<li>You can also select a particular schema to be the <strong>current</strong> schema

<ul>
<li><code>SET SCHEMA MovieInformation</code></li>
<li><code>USE MovieInformation</code></li>
<li class = '..
<br><br></li>
</ul></li>
<li>After'>this, you can create tables, etc.</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-12" style="background:;">
  <hgroup>
    <h2>Catalogs</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>Catalogs let you manage multiple schemas</li>
<li>They often correspond to different <strong>instances</strong> of a database</li>
<li>I.e., they are managed by different database processes</li>
<li>There is no standard way to create catalogs or select the current catalog</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-13" style="background:;">
  <hgroup>
    <h2>Database Processes</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>A <strong>SQL Server</strong> is just a database server</li>
<li>It handles requests and sends back responses (e.g., query results)
<br><br></li>
<li>A <strong>SQL Client</strong> is an application that sends requests to a SQL Server</li>
<li>Note a &quot;SQL Client&quot; may in turn be an &quot;application server&quot;</li>
<li>Words like &quot;client&quot; and &quot;server&quot; have limited meaning, but they are useful in the proper context</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-14" style="background:;">
  <hgroup>
    <h2>Connections</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>A SQL client needs a <strong>connection</strong> to talk to a database server</li>
<li><p>This may be as simple as</p>

<pre><code>CONNECT TO server_name AS connection_name AUTHORIZATION username AND password
</code></pre></li>
<li><p>Later, you can (and <strong>should</strong>) release the connection with</p>

<pre><code>DISCONNECT connection_name
</code></pre></li>
</ul>

<p><br></p>

<ul>
<li>Of course, the syntax for this is very incompatible between systems</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-15" style="background:;">
  <hgroup>
    <h2>Database Sessions</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>A <strong>session</strong> is associated with each connection</li>
<li>The session refers to the commands that are executed within a connection</li>
<li>Note: a session may consist of one or more <strong>transactions</strong></li>
</ul>

<p><br></p>

<ul>
<li>Sessions have state associated with them, including

<ul>
<li>current user, with associated privileges</li>
<li>user preferences (e.g., language)</li>
<li>current catalog, schema, etc.</li>
<li>database cursors</li>
</ul></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-16" style="background:;">
  <hgroup>
    <h2>SQL Modules</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>A <strong>SQL module</strong> is an application that interacts with the database</li>
<li>The SQL standard recognizes three types of modules:

<ol>
<li><strong>Generic SQL Interface</strong> allows a user to type in ad-hoc queries that are executed one at a time</li>
<li><strong>Embedded SQL</strong> involves SQL statements that are blended with the application language

<ul>
<li>Usually requires a preprocessor that extracts the SQL from the application language</li>
<li>The application language used to be COBOL, but it can be C or Java</li>
</ul></li>
<li><strong>True modules</strong> include a collection of cooperating application modules and stored procedures</li>
</ol></li>
</ul>

<p><br></p>

<ul>
<li>When a SQL module is executing, it is called a <strong>SQL agent</strong></li>
<li>This is the same distinction as between programs and processes</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-17" style="background:;">
  <hgroup>
    <h1>The SQL/Host Language Interface</h1>
  </hgroup>
  <article data-timings="">
    
  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-18" style="background:;">
  <hgroup>
    <h2>The SQL/Host Language Interface</h2>
  </hgroup>
  <article data-timings="">
    <div class="centered">
    <img src="assets/img/sql-host-interface.png" title="SQL/Host Language Interface" alt="SQL/Host Language Interface">
</div>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-19" style="background:;">
  <hgroup>
    <h2>The SQL/Host Language Interface</h2>
  </hgroup>
  <article data-timings="">
    <ol>
<li><strong>Call-Level Interface</strong> is a set of language functions that communicate with the database

<ul>
<li>E.g., it can be a set of Java classes that provide access to a database server</li>
<li>SQL queries are treated as <strong>strings</strong> only</li>
<li>So there is no syntax checking of SQL queries
<br><br></li>
</ul></li>
<li><strong>Embedded SQL</strong> is an approach where the language is <strong>extended</strong> to allow SQL in program blocks

<ul>
<li>There can be a specialized compiler than handles the extended language</li>
<li>Or there can be a preprocessor that converts the X+SQL into plain X using the call-level interface</li>
<li>In either case, syntax checking of SQL queries is possible</li>
</ul></li>
</ol>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-20" style="background:;">
  <hgroup>
    <h2>The Impedance Mismatch</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>Procedural languages have a strict set of data types (integers, strings, pointers, etc.)</li>
<li>They support mutable variables, loops, if statements, etc.</li>
<li>They work with one data at a time</li>
<li>In order to process N data items, they would use a loop</li>
</ul>

<p><br></p>

<ul>
<li>Databases work on many items at a time (e.g., all rows in a table)</li>
<li>They have predefined data types, some of which are specialized and ill-defined</li>
<li>They do not (for the most part) support if statements, loops, etc.</li>
</ul>

<p><br></p>

<ul>
<li>The challenge is to get these two different programming models to coexist</li>
<li>This is called the <strong>impedance mismatch</strong></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-21" style="background:;">
  <hgroup>
    <h2>Embedded SQL</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>Embedded SQL is one way to solve the impedance mismatch</li>
<li>This provides a special way to include SQL commands in C (or your programming language of choice)</li>
<li>The SQL code and C code communicate via shared variables</li>
</ul>

<pre><code>EXEC SQL BEGIN DECLARE SECTION;
    char studioName[50];
    int  presNetWorth;
    char SQLSTATE[6];
EXEC SQL END DECLARE SECTION;

strcpy(studioName, &quot;Lucasfilm&quot;);

EXEC SQL SELECT netWorth INTO :presNetWorth
           FROM Studios JOIN MovieExecs ON presC# = cert#
          WHERE Studios.name = :studioName;

printf (&quot;The president of Lucasfilm is worth $%d&quot;, presNetWorth);
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-22" style="background:;">
  <hgroup>
    <h2>Embedded SQL Concepts</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>SQL blocks are introduced via <code>EXEC SQL</code></li>
<li>The SQL code and C code communicate via shared variables

<ul>
<li>These look like regular variables to C</li>
<li>They have a leading &quot;:&quot; in the SQL code</li>
</ul></li>
<li>Shared variables are declared inside <code>DECLARE SECTION</code> blocks</li>
</ul>

<pre><code>EXEC SQL BEGIN DECLARE SECTION;
    char studioName[50];
    int  presNetWorth;
    char SQLSTATE[6];
EXEC SQL END DECLARE SECTION;
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-23" style="background:;">
  <hgroup>
    <h2>SQLSTATE</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>EXEC SQL BEGIN DECLARE SECTION;
    ...
    char SQLSTATE[6];
EXEC SQL END DECLARE SECTION;
</code></pre>

<ul>
<li>The variable SQLSTATE is special</li>
<li><p>If you declare a variable with this name (and you should), it will receive a special status code from the last SQL statement</p>

<ul>
<li>The codes are <strong>strings</strong> (not numbers) of 5 characters</li>
<li>(So in C, you must declare an array of 6 characters, to leave room for the trailing &#39;\0&#39; character)</li>
</ul></li>
<li><p>Many of the codes are standard (and many more are database-specific)</p>

<ul>
<li><strong>00000</strong> means &quot;no error&quot;</li>
<li><strong>02000</strong> means &quot;no (more) answers&quot;</li>
</ul></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-24" style="background:;">
  <hgroup>
    <h2>Cursors</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>In the last example, we saw a query that returned <strong>only one row</strong></li>
<li>But what if you want to find all the Movies made by Lucasfilm?</li>
<li>This is part of what we mean by <strong>impedance mismatch</strong></li>
</ul>

<p><br></p>

<ul>
<li>A modern solution might be to return a <strong>collection</strong> of results</li>
<li>You  have to be careful, because there may not be enough memory to hold all the results in the client</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-25" style="background:;">
  <hgroup>
    <h2>Cursors</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>A modern solution might be to return an <strong>iterator</strong> over a collection</li>
<li>This gives the illusion that we are working on a collection of items, but the collection may actually be held in the database</li>
<li>Note: This does <strong>not</strong> mean that getting the next result means sending a request to the database</li>
<li>I.e., the iterator may hold several results in memory at a time</li>
</ul>

<p><br></p>

<ul>
<li>A <strong>cursor</strong> is the database term for an iterator</li>
<li>It lets you step through all the rows in your query result</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-26" style="background:;">
  <hgroup>
    <h2>Using Cursors</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>To use a cursor from your code, you need to complete four steps</li>
</ul>

<p><br></p>

<ol>
<li><strong>Declare</strong> the cursor, which also associates it with a query</li>
<li><strong>Open</strong> the cursor, which initializes the query at the database</li>
<li><strong>Fetch</strong> each row</li>
<li><p><strong>Close</strong> the cursor when finished</p>

<pre><code>EXEC SQL DECLARE cursor_name CURSOR FOR query;
EXEC SQL OPEN cursor_name;
EXEC SQL FETCH FROM cursor_name INTO :var1, :var2, ..., :varn;
...
EXEC SQL CLOSE cursor_name;
</code></pre></li>
</ol>

<ul>
<li>Note: You know you&#39;re finished when SQLSTATE has the value <strong>02000</strong></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-27" style="background:;">
  <hgroup>
    <h2>Using Cursors</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>EXEC SQL BEGIN DECLARE SECTION;
    int  cert_number;
    char title[100];
    int  year;
    char SQLSTATE[6];
EXEC SQL END DECLARE SECTION;

EXEC SQL DECLARE c_movies CURSOR FOR
     SELECT title, year
       FROM Movies
      WHERE presC# = :cert_number
      ORDER BY year;
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-28" style="background:;">
  <hgroup>
    <h2>Using Cursors</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>EXEC SQL OPEN c_movies;
for (;;) {
    EXEC SQL FETCH FROM c_movies INTO :title, :year;
    if (!strcmp(SQLSTATE,&quot;02000&quot;))
        break;
    printf (&quot;%d, %s\n&quot;, year, title);
}
EXEC SQL CLOSE c_movies;
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-29" style="background:;">
  <hgroup>
    <h2>Modifying Rows</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>One way to modify rows is simply to execute an UPDATE command</li>
<li>Sometimes, it&#39;s convenient to update the row we happen to be reading currently</li>
<li>This is possible with cursors</li>
<li>The WHERE clause should be &quot;WHERE CURRENT OF cursor_name&quot;</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-30" style="background:;">
  <hgroup>
    <h2>Modifying Rows</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>EXEC SQL DECLARE c_emps CURSOR FOR
     SELECT employee_id, rating, salary
       FROM Employees;
EXEC SQL OPEN c_emps;
for (;;) {
    EXEC SQL FETCH FROM c_emps INTO :id, :rating, :salary;
    if (!strcmp(SQLSTATE,&quot;02000&quot;))
        break;
    if (rating &gt;= 9)
        EXEC SQL UPDATE Employees
                    SET salary = 1.1 * :salary
                  WHERE CURRENT OF c_emps;
    else if (rating &lt;= 2)
        EXEC SQL DELETE FROM Employees
                  WHERE CURRENT OF c_emps;
}
EXEC SQL CLOSE c_emps;
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-31" style="background:;">
  <hgroup>
    <h2>Dynamic SQL</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>So far, the SQL code that will be executed has been visible in the code</li>
<li>But what if you have to create the SQL code in C?</li>
<li><p>E.g., your application can build a string by appending conditions to some base</p>

<pre><code>q = &quot;SELECT * FROM Employees WHERE rating &gt;= 10&quot;;
q = q + &quot; AND location=&#39;US&#39;&quot;;
q = q + &quot; AND last_name LIKE &#39;%jones%&quot;;
</code></pre></li>
<li><p>Note: You should <strong>avoid</strong> dynamic SQL</p></li>
<li><p>Repeat: <strong>Avoid</strong> dynamic SQL</p></li>
</ul>

<p><br></p>

<ul>
<li>Note: If all that changes is a parameter, you can use static SQL and a shared variable</li>
<li>E.g., &quot;rating &gt;= :min_rating&quot;</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-32" style="background:;">
  <hgroup>
    <h2>Using Cursors</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>EXEC SQL BEGIN DECLARE SECTION;
    int  cert_number;
    char *query = &quot;SELECT title, year
                     FROM Movies
                    WHERE presC# = :cert_number&quot;;
EXEC SQL END DECLARE SECTION;
EXEC SQL PREPARE sql_query FROM :query;
EXEC SQL DECLARE c_query CURSOR FOR sql_query;

cert_number = 12345;
EXEC SQL OPEN c_query;
for (;;) {
    EXEC SQL FETCH FROM c_query INTO :title, :year;
    if (!strcmp(SQLSTATE,&quot;02000&quot;))
        break;
    printf (&quot;%d, %s\n&quot;, year, title);
}
EXEC SQL CLOSE c_movies;
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-33" style="background:;">
  <hgroup>
    <h2>Using Cursors</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>EXEC SQL BEGIN DECLARE SECTION;
    int  cert_number;
    char *query = &quot;SELECT title, year
                     FROM Movies
                    WHERE presC# = ?&quot;;
EXEC SQL END DECLARE SECTION;
EXEC SQL PREPARE sql_query FROM :query;
EXEC SQL DECLARE c_query CURSOR FOR sql_query;

cert_number = 12345;
EXEC SQL OPEN c_query USING :cert_number;
for (;;) {
    EXEC SQL FETCH FROM c_query INTO :title, :year;
    if (!strcmp(SQLSTATE,&quot;02000&quot;))
        break;
    printf (&quot;%d, %s\n&quot;, year, title);
}
EXEC SQL CLOSE c_movies;
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-34" style="background:;">
  <hgroup>
    <h1>Stored Procedures</h1>
  </hgroup>
  <article data-timings="">
    
  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-35" style="background:;">
  <hgroup>
    <h2>Stored Procedures and Functions</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>The SQL standard defines <strong>stored procedures</strong></li>
<li>This is a bit of SQL (plus some extensions) that is stored with the database</li>
<li>You can <strong>call</strong> it from the SQL interface</li>
<li>You write a stored procedure to <strong>perform an action</strong>, e.g., insert a student to the database
<br><br></li>
<li>There are also <strong>stored functions</strong></li>
<li>These are similar, but also return a value</li>
<li>You call them from a query, wherever you can use an expression</li>
<li>E.g., you can write a function that converts a date to a Julian number</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-36" style="background:;">
  <hgroup>
    <h2>Stored Procedures and Functions</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>CREATE PROCEDURE Move(IN oldAddr VARCHAR(255),
                      IN newAddr VARCHAR(255))
BEGIN
    UPDATE MovieStar
       SET address = newAddr
     WHERE address = oldAddr;
END;
</code></pre>

<pre><code>CALL Move (&#39;1 Innovation Way&#39;, &#39;1 Infinite Loop&#39;);
</code></pre>

<pre><code>EXEC SQL CALL Move (&#39;1 Innovation Way&#39;, &#39;1 Infinite Loop&#39;);
</code></pre>

<p>Note: SQL recognizes IN, OUT, and INOUT parameters</p>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-37" style="background:;">
  <hgroup>
    <h2>Stored Procedures and Functions</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>CREATE FUNCTION NumMovies(IN name VARCHAR(255)) RETURNS NUMBER
BEGIN
    RETURN (SELECT COUNT(*)
              FROM StarsIn
             WHERE StarsIn.starName = name);
END;
</code></pre>

<pre><code>SELECT name, NumMovies(name)
  FROM Stars
 WHERE NumMovies(name) &gt; 10
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-38" style="background:;">
  <hgroup>
    <h2>Procedural Extensions</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>The body of a procedure or function can be <strong>procedural</strong></li>
<li>I.e., it can have

<ul>
<li>variables</li>
<li>assignment statements</li>
<li>multiple statements</li>
<li>conditional statements</li>
<li>loops</li>
</ul></li>
<li>The syntax is loosely based on Ada (but you can&#39;t blame Ada for this)</li>
</ul>

<p><br></p>

<ul>
<li>Of course, the body can also call other stored procedures or functions</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-39" style="background:;">
  <hgroup>
    <h2>Variables</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>CREATE FUNCTION NumMovies(IN name VARCHAR(255)) RETURNS NUMBER
DECLARE movieCount NUMBER;
BEGIN
    SET movieCount = (SELECT COUNT(*)
                        FROM StarsIn
                       WHERE StarsIn.starName = name);
    RETURN movieCount;
END;
</code></pre>

<ul>
<li>The SET keyword is mandatory</li>
<li>This is the way we can tell the difference between assignment and equality comparisons</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-40" style="background:;">
  <hgroup>
    <h2>Conditional Statements</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>The syntax is <code>IF ... THEN ... ELSEIF ... THEN ... ELSE ... END IF</code></li>
</ul>

<pre><code>CREATE FUNCTION StarList(IN name VARCHAR(255)) RETURNS NUMBER
DECLARE movieCount NUMBER;
BEGIN
    SET movieCount = NumMovies(name);
    IF movieCount &gt; 10 THEN
        RETURN &#39;A-list&#39;;
    ELSEIF movieCount &gt; 5 THEN
        RETURN &#39;B-list&#39;;
    ELSE
        RETURN &#39;C-list&#39;;
    ENDIF;
END;
</code></pre>

<p>Note: EXISTS and NOT EXISTS are used in the condition often</p>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-41" style="background:;">
  <hgroup>
    <h2>Loops</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>CREATE FUNCTION triangle(IN n NUMBER) RETURNS NUMBER
DECLARE i NUMBER;
DECLARE t NUMBER;
BEGIN
    SET t = 0;
    SET i = 0;
    mainLoop: LOOP
        IF i &gt; n THEN
            LEAVE mainLoop;
        END IF;
        SET t = t + i;
        SET i = i + 1;
    END LOOP;
    RETURN t;
END;
</code></pre>

<ul>
<li>Loops must have labels</li>
<li>Use LEAVE to exit loops</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-42" style="background:;">
  <hgroup>
    <h2>Loops and Cursors</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>CREATE FUNCTION AvgNumMovies() RETURNS NUMBER
DECLARE movieSum    NUMBER;
DECLARE starCount   NUMBER;
DECLARE starName    VARCHAR(255);
DECLARE movieCount  NUMBER;
DECLARE movieCursor FOR
    SELECT movieStar, COUNT(movieTitle)
      FROM StarsIn
     GROUP BY movieStar;
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-43" style="background:;">
  <hgroup>
    <h2>Loops and Cursors</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>BEGIN
    SET movieSum  = 0;
    SET starCount = 0;
    OPEN movieCursor;
    mainLoop: LOOP
        FETCH FROM movieCursor INTO starName, movieCount;
        IF SQLSTATE &#39;02000&#39; THEN
            LEAVE mainLoop;
        END IF;
        SET movieSum  = movieSum + movieCount;
        SET starCount = starCount + 1;
    END LOOP;
    CLOSE movieCursor;
    RETURN movieSum / starCount;
END;
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-44" style="background:;">
  <hgroup>
    <h2>Loops and Cursors</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>CREATE FUNCTION AvgMovieLength(IN s VARCHAR(255)) RETURNS NUMBER
DECLARE movieSum    NUMBER;
DECLARE movieCount  NUMBER;
DECLARE title       VARCHAR(255);
DECLARE year        NUMBER;
DECLARE length      NUMBER;
DECLARE movieCursor FOR
    SELECT title, year, length
      FROM Movies
     WHERE studioName = s;
DECLARE NoMoreRows CONDITION FOR SQLSTATE &#39;02000&#39;;
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-45" style="background:;">
  <hgroup>
    <h2>Loops and Cursors</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>BEGIN
    SET movieSum   = 0;
    SET movieCount = 0;
    OPEN movieCursor;
    mainLoop: LOOP
        FETCH FROM movieCursor INTO title, year, length;
        IF NoMoreRows THEN
            LEAVE mainLoop;
        END IF;
        SET movieSum   = movieSum + length;
        SET movieCount = movieCount + 1;
    END LOOP;
    CLOSE movieCursor;
    RETURN movieSum / movieCount;
END;
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-46" style="background:;">
  <hgroup>
    <h2>FOR Loops</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>SQL support FOR loops!</li>
<li>But they are not like FOR loops in any other language</li>
<li>They iterate over cursors</li>
</ul>

<p><br></p>

<ul>
<li>The advantage of using FOR loops is that they handle the details of handling cursors automatically</li>
</ul>

<p><br></p>

<ul>
<li>But FOR loops are really syntactic sugar</li>
<li>A preprocessor converts them into conventional LOOPs before compilation</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-47" style="background:;">
  <hgroup>
    <h2>FOR Loops</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>CREATE FUNCTION AvgMovieLength(IN s VARCHAR(255)) RETURNS NUMBER
DECLARE movieSum    NUMBER;
DECLARE movieCount  NUMBER;
BEGIN
    SET movieSum   = 0;
    SET movieCount = 0;
    FOR movieLoop AS movieCursor CURSOR FOR
        SELECT title, year, length
          FROM Movies
         WHERE studioName = s;
    DO
        SET movieSum   = movieSum + length;
        SET movieCount = movieCount + 1;
    END LOOP;
    RETURN movieSum / movieCount;
END;
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-48" style="background:;">
  <hgroup>
    <h2>WHILE Loops</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>CREATE FUNCTION triangle(IN n NUMBER) RETURNS NUMBER
DECLARE i NUMBER;
DECLARE t NUMBER;
BEGIN
    SET t = 0;
    SET i = 0;
    WHILE i &lt;= n DO
        SET t = t + i;
        SET i = i + 1;
    END WHILE;
    RETURN t;
END;
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-49" style="background:;">
  <hgroup>
    <h2>REPEAT Loops</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>CREATE FUNCTION triangle(IN n NUMBER) RETURNS NUMBER
DECLARE i NUMBER;
DECLARE t NUMBER;
BEGIN
    SET t = 0;
    SET i = 0;
    REPEAT
        SET t = t + i;
        SET i = i + 1;
    UNTIL i &gt; n
    END WHILE;
    RETURN t;
END;
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-50" style="background:;">
  <hgroup>
    <h2>Exceptions</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>Exceptions are tied to SQLSTATE</li>
<li>I.e., you can add an exception to handle the case when no more tuples are found

<ul>
<li>SQLSTATE = &#39;02000&#39;</li>
</ul></li>
<li>Or when a nested query returns more than one result

<ul>
<li>SQLSTATE = &#39;21000&#39;</li>
</ul></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-51" style="background:;">
  <hgroup>
    <h2>Exceptions</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>CREATE FUNCTION GetYear(IN t VARCHAR(255)) RETURNS NUMBER
DECLARE NoMoreRows  CONDITION FOR SQLSTATE &#39;02000&#39;;
DECLARE TooManyRows CONDITION FOR SQLSTATE &#39;21000&#39;;
BEGIN
    DECLARE EXIT HANDLER FOR NoMoreRows, TooManyRows 
        RETURN NULL;
    RETURN (SELECT year FROM Movies WHERE title = t);
END;
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-52" style="background:;">
  <hgroup>
    <h2>Exceptions</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>DECLARE EXIT HANDLER FOR NoMoreRows, TooManyRows 
    SET year = NULL;
</code></pre>

<ul>
<li>The EXIT keyword says that control should follow after the BEGIN ... END block</li>
<li>You can also specify

<ul>
<li>CONTINUE, which means go on to the next statement, as if nothing had happened</li>
<li>UNDO, which is just like EXIT but also enforces transaction semantics,
including <strong>updates</strong> and <strong>assignment statements</strong></li>
</ul></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-53" style="background:;">
  <hgroup>
    <h1>Call-Level Interface</h1>
  </hgroup>
  <article data-timings="">
    
  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-54" style="background:;">
  <hgroup>
    <h2>Call-Level Interface</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>The more common approach to interacting with a database is to use a <strong>library</strong> that connects
to the database</li>
<li>SQL queries are handled as strings</li>
<li>The library is called a <strong>call-level interface</strong> or <strong>CLI</strong></li>
</ul>

<p><br></p>

<ul>
<li><p>Advantages:</p>

<ul>
<li>No need for a pre-processor</li>
<li>Programming tools (debugger, editor, syntax highlighter) work &quot;as-is&quot;</li>
</ul></li>
<li><p>Disadvantage:</p>

<ul>
<li>SQL queries are checked at run-time, not at compile-time</li>
</ul></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-55" style="background:;">
  <hgroup>
    <h2>JDBC</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li><strong>JDBC</strong> is Java&#39;s base database connectivity API

<ul>
<li>Java offers other alternatives, e.g., SQLJ and JDO, which sit on top of JDBC
<br><br></li>
</ul></li>
<li>JDBC is DBMS-neutral

<ul>
<li>A <strong>driver</strong> traps calls and translates them into DBMS-specific code</li>
<li>But SQL commands are strings and not completely portable
<br><br></li>
</ul></li>
<li>Database can run across a network, and connection info is passed in the form of URLs </li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-56" style="background:;">
  <hgroup>
    <h2>JDBC Architecture</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li> <strong>Application:</strong> initiates and terminates connections, and submits SQL statements
<br><br></li>
<li> <strong>Driver Manager:</strong> only one per Java instance.  It loads the right JDBC driver for the given connection
<br><br></li>
<li> <strong>Driver:</strong> connects to the data source, transmits requests, and returns/translates results and error codes
<br><br></li>
<li> <strong>Data source:</strong> the actual database that processes SQL statements</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-57" style="background:;">
  <hgroup>
    <h2>Basic JDBC Application</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>The Java application must perform the following steps

<ul>
<li>Load the JDBC driver (e.g., Oracle&#39;s JDBC driver).  This also registers the driver with the driver manager</li>
<li>Connect to the data source (e.g., provide username/password)</li>
<li>Execute SQL statements</li>
<li>Close all open statements and connections</li>
<li>Handle exceptions</li>
</ul></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-58" style="background:;">
  <hgroup>
    <h2>DriverManager</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li><strong>DriverManager</strong> is a class implemented in the JDBC library</li>
<li>It&#39;s responsible for creating an instance of the right driver for your database connection</li>
<li>But, it needs to know which database drivers work for which connections types</li>
<li>This is done by <strong>registering</strong> the driver, and drivers register themselves when they are loaded</li>
<li>You can load a driver by creating an instance of it or loading the class</li>
</ul>

<pre><code>Class.forName(&quot;jdbc.driver.Oracledriver&quot;);
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-59" style="background:;">
  <hgroup>
    <h2>JDBC Sessions and Connections</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>We interact with a data source through a session</li>
<li>This is not just a JDBC notion, but a database notion</li>
<li>A session has its own set of preferences, etc.</li>
<li>Sessions are initiated via a URL

<ul>
<li>jdbc:<em>subprotocol</em>:<em>otherparameters</em></li>
<li>The <em>subprotocol</em> identifies the driver, e.g., Oracle</li>
<li>The <em>otherParameters</em> is driver specific, e.g., username/password, network port, database name, etc.</li>
</ul></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-60" style="background:;">
  <hgroup>
    <h2>Starting a Connection</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>Class.forName(&quot;jdbc.driver.Oracledriver&quot;);

String url = &quot;jdbc:oracle:www.bookstore.com:3083&quot;;
Connection conn;
try {
    con = DriverManager.getConnection(url, &quot;scott&quot;, &quot;tiger&quot;);
}
catch (SQLException e) {
    // handle error
}
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-61" style="background:;">
  <hgroup>
    <h2>Connection Configuration</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>How do we know to

<ul>
<li>connect to <em>jdbc:oracle:<a href="http://www.bookstore.com:3083">www.bookstore.com:3083</a></em></li>
<li>username/password is <em>scott/tiger</em></li>
</ul></li>
<li>These credentials should be different in development, testing, production, etc.</li>
</ul>

<p><br></p>

<ul>
<li>There are 5 typical solutions:

<ul>
<li>Hardcode them in the source file (like we did) -- <strong>bad</strong> idea</li>
<li>Get information from a <strong>property file</strong></li>
<li>Use <strong>dependency injection</strong> (pass the buck)</li>
<li>Use a framework (JNDI) that gives you the connection URL</li>
<li>Use a framework (J2EE, Spring) that connects to the database for you and gives you a Connection</li>
</ul></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-62" style="background:;">
  <hgroup>
    <h2>Aside: Dependency Injection</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li><strong>Dependency Injection (DI)</strong> is a great technique for writing code that is <strong>loosely coupled</strong></li>
<li>E.g., the code uses a database, but does not need to know <strong>what database it uses</strong></li>
</ul>

<p><br></p>

<ul>
<li>This is huge!</li>
<li>It allows us to use a bit of code in many different contexts</li>
<li>So it makes code reuse much more likely</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-63" style="background:;">
  <hgroup>
    <h2>Aside: Dependency Injection</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li><p>The basic idea is <strong>not to write</strong> code like this:</p>

<pre><code>Class.forName(&quot;jdbc.driver.Oracledriver&quot;);

String url = &quot;jdbc:oracle:www.bookstore.com:3083&quot;;
Connection conn;
try {
  con = DriverManager.getConnection(url, &quot;scott&quot;, &quot;tiger&quot;);
}
</code></pre></li>
<li><p>Notice all the assumptions this little bit of code is making about its environment</p></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-64" style="background:;">
  <hgroup>
    <h2>Aside: Dependency Injection</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li><p>Instead, write code like this</p>

<pre><code>class Foo {
  public void setDriverName (String driver) { this.dbDriver = driver; }
  public void setConnectionUrl (String url) { this.dbUrl = url; }
  public void setDbUser (String user) { this.dbUser = user; }
  public void setDbPassword (String password) { this.dbPassword = password; }
  ...
  public void connect() {
      Class.forName(dbDriver);
      Connection con;
      try {
           DriverManager.getConnection (dbUrl, dbUser, dbPassword);
      }
      ...
  }
}
</code></pre></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-65" style="background:;">
  <hgroup>
    <h2>Connection API</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li><strong>getTransactionIsolation()</strong> and <strong>setTransactionIsolation()</strong></li>
</ul>

<p><br></p>

<ul>
<li><strong>getReadOnly()</strong> and <strong>setReadOnly()</strong></li>
</ul>

<p><br></p>

<ul>
<li><strong>getAutoCommit()</strong> and <strong>setAutoCommit()</strong>

<ul>
<li>If true (default), each SQL statement executes in its own transaction</li>
<li>If false, you must explicitly call <strong>commit()</strong> or <strong>rollback()</strong></li>
</ul></li>
</ul>

<p><br></p>

<ul>
<li><strong>isClosed()</strong></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-66" style="background:;">
  <hgroup>
    <h2>Executing SQL Statements</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li><p>JDBC offers three classes for interacting with SQL statements</p>

<ul>
<li><strong>Statement:</strong> both static and dynamic</li>
<li><strong>PreparedStatement:</strong> allows parameters, e.g., :cert_num</li>
<li><strong>CallableStatement:</strong> calls a stored procedure (if your database supports these)</li>
</ul></li>
<li><p>You can call <strong>executeUpdate()</strong> or <strong>executeQuery()</strong> to execute a query</p></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-67" style="background:;">
  <hgroup>
    <h2>Executing SQL Statements</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>// The &quot;?&quot; indicate where the parameters go
String sql=&quot;INSERT INTO Movies (title, year, genre, length) VALUES(?,?,?,?)&quot;;

PreparedStatment pstmt=con.prepareStatement(sql);
pstmt.clearParameters(); // not needed here
pstmt.setString(1, title);     // one- (not zero-)based offsets
pstmt.setInt(2, year);
pstmt.setString(3, genre);
pstmt.setInt(4, length);

// no rows are returned, thus we use executeUpdate()
int numRowsChanged = pstmt.executeUpdate();
</code></pre>

<p>Note: You can use column names instead of position indexes in the getXXX() and setXXX() methods</p>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-68" style="background:;">
  <hgroup>
    <h2>Getting Results Back</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li><strong>executeUpdate()</strong> returns the number of rows affected by the query

<ul>
<li>Useful to make sure you changed the expected number of records</li>
<li>E.g., 1 for an insert</li>
</ul></li>
<li><strong>executeQuery()</strong> returns rows encapsulated in a <strong>ResultSet</strong>

<ul>
<li>ResultSet is JDBC&#39;s class for representing a database cursor</li>
</ul></li>
</ul>

<pre><code>ResultSet rs=pstmt.executeQuery(sql);
// rs is now a cursor
while (rs.next()) {
  // process the data
}
rs.close ();
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-69" style="background:;">
  <hgroup>
    <h2>ResultSet</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>ResultSet has some powerful features

<ul>
<li><strong>next():</strong> moves to the next row, and returns false if none</li>
<li><strong>previous():</strong> moves to the previous row</li>
<li><strong>absolute(n):</strong> moves to the nth row</li>
<li><strong>relative(n):</strong> moves forward (backward if n is negative) by n rows</li>
<li><strong>first()} / \textbf{last():</strong> moves to the first / last row</li>
</ul></li>
</ul>

<p><br></p>

<ul>
<li>If your database supports it, ResultSet also allows you to modify the current row</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-70" style="background:;">
  <hgroup>
    <h2>SQL/Java Data Types</h2>
  </hgroup>
  <article data-timings="">
    <table><thead>
<tr>
<th>SQL Type</th>
<th>Java Class</th>
<th>ResultSet get/set Method</th>
</tr>
</thead><tbody>
<tr>
<td>BIT</td>
<td>Boolean</td>
<td>getBoolean()</td>
</tr>
<tr>
<td>CHAR</td>
<td>String</td>
<td>getString()</td>
</tr>
<tr>
<td>VARCHAR</td>
<td>String</td>
<td>getString()</td>
</tr>
<tr>
<td>DOUBLE</td>
<td>Double</td>
<td>getDouble()</td>
</tr>
<tr>
<td>FLOAT</td>
<td>Double</td>
<td>getDouble()</td>
</tr>
<tr>
<td>INTEGER</td>
<td>Integer</td>
<td>getInt()</td>
</tr>
<tr>
<td>REAL</td>
<td>Double</td>
<td>getFloat()</td>
</tr>
<tr>
<td>DATE</td>
<td>java.sql.Date</td>
<td>getDate()</td>
</tr>
<tr>
<td>TIME</td>
<td>java.sql.Time</td>
<td>getTime()</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>java.sql.TimeStamp</td>
<td>getTimestamp()</td>
</tr>
</tbody></table>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-71" style="background:;">
  <hgroup>
    <h2>Dealing with SQL NULL Values</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li><p>If a field is NULL, the getXXX() will return Java null if possible</p>

<pre><code>String title = rs.getString(1);
if (title == null) {
  ...
}
</code></pre></li>
<li><p>But some types (e.g., int, float, double) do not have NULL equivalents</p></li>
<li><p>In this case, you can use <strong>wasNull()</strong> to check</p>

<pre><code>int year = rs.getInt(2);
if (rs.wasNull()) {
...
}
</code></pre></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-72" style="background:;">
  <hgroup>
    <h2>SQL Injection</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>Suppose you have a login form, and you process the input like this</li>
</ul>

<pre><code>String sql = &quot;SELECT id FROM login &quot; +
             &quot;WHERE username = &#39;&quot; + form.username + &quot;&#39;&quot; +
             &quot;AND password = &#39;&quot; + form.password + &quot;&#39;&quot;;

// Now execute the SQL statement to get the id for the user
// (if the username and password are correct)
</code></pre>

<ul>
<li>With these inputs, the query translates as follows

<ul>
<li>Username: ruben</li>
<li>Password: p@ssw0rd</li>
</ul></li>
</ul>

<pre><code>SELECT id
  FROM login
 WHERE username = &#39;ruben&#39;
   AND password = &#39;p@ssw0rd&#39;
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-73" style="background:;">
  <hgroup>
    <h2>SQL Injection</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>The problem is that not everybody plays fair</li>
<li>You&#39;re letting the user help you write the SQL queries</li>
<li>Some (ab)users will take advantage of this</li>
<li>And users are much more creative in their capacity for mischief than you can imagine</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-74" style="background:;">
  <hgroup>
    <h2>SQL Injection</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>Suppose you have a login form, and you process the input like this</li>
</ul>

<pre><code>String sql = &quot;SELECT id FROM login &quot; +
             &quot;WHERE username = &#39;&quot; + form.username + &quot;&#39;&quot; +
             &quot;AND password = &#39;&quot; + form.password + &quot;&#39;&quot;;

// Now execute the SQL statement to get the id for the user
// (if the username and password are correct)
</code></pre>

<ul>
<li>With these inputs, the query translates as follows

<ul>
<li>Username: administrator</li>
<li>Password: &#39; OR &#39;pwned&#39; = &#39;pwned</li>
</ul></li>
</ul>

<pre><code>SELECT id
  FROM login
 WHERE username = &#39;administrator&#39;
   AND password = &#39;&#39; OR &#39;pwned&#39; = &#39;pwned&#39;
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-75" style="background:;">
  <hgroup>
    <h2>SQL Injection</h2>
  </hgroup>
  <article data-timings="">
    <div class="centered">
    <img src="assets/img/exploits_of_a_mom.png" title="XKCD: Bobby Tables" alt="XKCD: Bobby Tables">
</div>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-76" style="background:;">
  <hgroup>
    <h2>Handling Exceptions</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>Almost all <strong>java.sql</strong> functions can throw a <strong>SQLException</strong> if an error occurs</li>
<li>Your code must explicitly deal with this exception

<ul>
<li>ignore it (i.e., add it to the list of throws and let the caller handle it)</li>
<li>catch it and recover</li>
<li>catch it and fail or terminate the program</li>
</ul></li>
</ul>

<p><br></p>

<ul>
<li><strong>Note:</strong> SQLException is a checked exception, so you must do <strong>something</strong></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-77" style="background:;">
  <hgroup>
    <h2>Handling Exceptions</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>try {
    con = DriverManager.getConnection(url, &quot;scott&quot;, &quot;tiger&quot;);
    pstmt = con.prepareStatement(sql);
    rs = pstmt.executeQuery ();
    while (rs.next ()) {
        // ... rs.getString(1) ...
    }
    // DO NOT close resources here!  
    // (See finally clause on next page)
}
catch (SQLException e) {
    // handle error, e.g., print message, terminate
    // ... e.getErrorCode() ...
    // ... e.getSQLState() ...
    // ... e.getMessage() ...
}
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-78" style="background:;">
  <hgroup>
    <h2>Handling Exceptions</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>finally {
    if (rs != null) {
        try {
            rs.close ();
        }
        catch (SQLException e2) {
            // handle it....
        }
    }
    if (pstmt != null) {
        try {
            pstmt.close ();
        }
        catch (SQLException e2) {
            // handle it....
        }
    }
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-79" style="background:;">
  <hgroup>
    <h2>Handling Exceptions</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>    if (con != null) {
        try { con.close (); }
        catch (SQLException e2) {
            // handle it....
        }
    }
}
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-80" style="background:;">
  <hgroup>
    <h2>Database Metadata</h2>
  </hgroup>
  <article data-timings="">
    <p>The <strong>DatabaseMetaData</strong> object gives information about the database system and the catalog</p>

<pre><code>DatabaseMetaData md = con.getMetaData();
System.out.println (&quot;Name: &quot; + md.getDriverName());
System.out.println (&quot;Version: &quot; + md.getDriverVersion());
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-81" style="background:;">
  <hgroup>
    <h2>Database Metadata</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>DatabaseMetaData md=con.getMetaData();
ResultSet trs=md.getTables(null,null,null,null);
String tableName;
while(trs.next()) {
  tableName = trs.getString(&quot;TABLE_NAME&quot;);
  System.out.println(&quot;Table: &quot; + tableName);
  ResultSet crs = md.getColumns(null,null,tableName, null);
  while (crs.next()) {
    System.out.println(&quot;  &quot; + crs.getString(&quot;COLUMN_NAME&quot;));
  }
}
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-82" style="background:;">
  <hgroup>
    <h2>ResultSet Metadata</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>You can also get metadata from a ResultSet</li>
<li>The <strong>ResultSetMetaData</strong> class allows you to see the names and types of columns returned by
a ResultSet

<ul>
<li>Usually, you don&#39;t need this!</li>
<li>You <strong>know</strong> what the query is that you&#39;re executing, so you know the columns returned</li>
</ul></li>
</ul>

<p><br></p>

<ul>
<li>This is only useful with <strong>dynamic SQL</strong></li>
<li>E.g., a program that provides a GUI to execute arbitrary SQL statements</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-83" style="background:;">
  <hgroup>
    <h2>Template for Executing Queries</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>try { 
    con = DriverManager.getConnection(url, &quot;login&quot;, &quot;pass&quot;); 
    String query = &quot;SELECT title, year FROM Movies&quot;;
    stmt = con.prepareStatement(query); 
    rs = pstmt.executeQuery();
    while (rs.next()) {
        String title = rs.getString(&quot;title&quot;);
        int year = rs.getInt(&quot;year&quot;);
        System.out.println(title + &quot;    &quot; + year);
    }
} 
catch(SQLException ex) {
    System.out.println(ex.getMessage ()
        + ex.getSQLState () + ex.getErrorCode ());
}
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-84" style="background:;">
  <hgroup>
    <h2>Template for Executing Queries</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>finally {
    if (rs != null) {
        try {
            rs.close ();
        }
        catch (SQLException e2) {
            // handle it somehow
            // e.g., log it or retry N times....
        }
    }
    if (pstmt != null) {
        try {
            pstmt.close ();
        }
        catch (SQLException e2) {
            // handle it somehow
        }
    }
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-85" style="background:;">
  <hgroup>
    <h2>Template for Executing Queries</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>    if (con != null) {
        try {
            con.close ();
        }
        catch (SQLException e2) {
            // handle it somehow
        }
    }
} // end finally
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-86" style="background:;">
  <hgroup>
    <h1>Spring Database Templates</h1>
  </hgroup>
  <article data-timings="">
    
  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-87" style="background:;">
  <hgroup>
    <h2>Spring Database Templates</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>Spring is a Java framework that makes it easier to build enterprise applications</li>
<li>It started out as a way to access databases via <strong>templates</strong></li>
<li>It grew to a <strong>dependency injection</strong> framework that 

<ul>
<li>defines <strong>beans</strong> (run-time objects that perform some functionality)</li>
<li><strong>wires</strong> beans together (sets up the run-time graph of cooperating objects)</li>
<li class = '..</li>
</ul></li>
</ul>

<p><br></p>

<ul>
<li>You&#39;ve'>probably noticed it takes a lot of (repetitive) code to execute even a simple query!</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-88" style="background:;">
  <hgroup>
    <h2>Specifying the Database</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>First things first -- we need to tell the application what database to use</li>
</ul>

<pre><code>@Configuration
@Import({JettyConfiguration.class, SpringSecurityConfiguration.class})
@ComponentScan(basePackages = {&quot;uwyo.cs.acm2013&quot;},
               excludeFilters = {@ComponentScan.Filter(Controller.class),
                                 @ComponentScan.Filter(Configuration.class)})
public class RootConfiguration {
    @Bean
    public DataSource getDataSource() {
      DataSource dbsrc = null;
      try {
          dbsrc = new SimpleDriverDataSource(new com.mysql.jdbc.Driver(),
                                             &quot;jdbc:mysql://localhost/test&quot;, 
                                             &quot;root&quot;, &quot;&quot;);
      } catch (SQLException e) {
          e.printStackTrace();
      }      
      return dbsrc;
    }
}
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-89" style="background:;">
  <hgroup>
    <h2>Data Access Objects</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>Spring uses <strong>Data Access Objects</strong> or <strong>DAOs</strong></li>
<li>These are classes that interface with the database</li>
<li>Each method of a DAO corresponds to a concrete chunk of functionality

<ul>
<li>E.g., find movies made in a certain year</li>
</ul></li>
<li>The method returns Java objects called <strong>Data Transfer Objects</strong> or <strong>DTOs</strong></li>
</ul>

<p><br></p>

<ul>
<li>DTOs usually don&#39;t have sophisticated behavior</li>
<li>They can be converted into model objects (which may have behavior)</li>
<li>But DTOs are only designed to transfer information</li>
<li>I.e., they do not follow the typical OO design strategies</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-90" style="background:;">
  <hgroup>
    <h2>Writing a DAO</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>public class TestDAOImpl implements TestDAO {

    private JdbcTemplate jdbcTemplate = null;

    public TestDAOImpl(DataSource dataSource) {
        jdbcTemplate = new JdbcTemplate(dataSource);
    }
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-91" style="background:;">
  <hgroup>
    <h2>Writing a DAO</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>    @Override
    public List&lt;Foo&gt; getFoos() {
        String sql = &quot;SELECT a, b FROM foo&quot;;
        List&lt;Foo&gt; foos = jdbcTemplate.query(sql, new RowMapper&lt;Foo&gt;() {

            @Override
            public Foo mapRow(ResultSet rs, int rowNum) throws SQLException {
                Foo foo = new Foo(rs.getInt(&quot;a&quot;), rs.getInt(&quot;b&quot;));
                return foo;
            }

        });

        return foos;
    }
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-92" style="background:;">
  <hgroup>
    <h2>Writing a DAO</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>    @Override
    public void deleteFoo(int a) {
        String sql = &quot;DELETE FROM foo WHERE a=?&quot;;
        jdbcTemplate.update(sql, a);
    }

}
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-93" style="background:;">
  <hgroup>
    <h1>SQLJ</h1>
  </hgroup>
  <article data-timings="">
    
  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-94" style="background:;">
  <hgroup>
    <h2>SQLJ</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>SQLJ is part of the JDBC standard</li>
<li>It is similar in spirit to Embedded SQL, but it is DBMS independent, like JDBC itself

<ul>
<li>Recall: Embedded SQL is defined by each vendor, and each vendor provides the tools to compile it</li>
</ul></li>
<li>SQL has the key advantage of Embedded SQL

<ul>
<li>Compiler can perform syntax checks and even consistency with the schema</li>
</ul></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-95" style="background:;">
  <hgroup>
    <h2>SQLJ</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>int    sid; 
String name; 
float  gpa;
#sql iterator Students(int sid, String name, float gpa);
Students students;
#students = {
    SELECT sname, gpa INTO :name, :gpa
      FROM Students 
     WHERE sid = :sid
};
while (students.next()) {
    System.out.println(students.name + &quot; &quot; + students.gpa));
}
students.close();
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-96" style="background:;">
  <hgroup>
    <h2>SQLJ Iterators</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>Named iterators

<ul>
<li>Need both variable type and name</li>
<li>Allows retrieval of columns by name</li>
</ul></li>
<li>Positional iterators

<ul>
<li>Need only variable type</li>
<li>Uses <strong>FETCH ... INTO</strong> to write to Java variables</li>
</ul></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-97" style="background:;">
  <hgroup>
    <h1>Object-Relational Mappers (ORMs)</h1>
  </hgroup>
  <article data-timings="">
    
  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-98" style="background:;">
  <hgroup>
    <h2>Object-Relational Mappers (ORMs)</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>Another approach is to completely disguise the database behind classes that correspond 
to the tables in the database</li>
<li>E.g., there would be a Sailor class, a Boat class, etc.</li>
<li>Instances of the class correspond to rows in the table</li>
</ul>

<p><br></p>

<ul>
<li><strong>Class methods</strong> are used to create instance(s) from row(s) in the database</li>
<li><strong>Instance methods</strong> can read attributes from the instance, modify the instance, 
save instance to a new or existing row, etc.</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-99" style="background:;">
  <hgroup>
    <h2>Hibernate Example</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>Session session = factory.getCurrentSession ();
session.beginTransaction();

Student student = new Student(9, &quot;John Galt&quot;, 4.0);
session.save (student);

session.getTransaction().commit();
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-100" style="background:;">
  <hgroup>
    <h2>Hibernate Example</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>String hql = &quot;from Student s where s.gpa &lt;= :min_gpa&quot;;
Query query = session.createQuery ();
query.setFloat (&quot;min_gpa&quot;, 2.0);
List&lt;Student&gt; students = query.list (hql);
    // Note: List&lt;Student&gt; is a Java class

for (Student student : students) {
    // Note: student is a POJO
    // Now do something with student
}
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-101" style="background:;">
  <hgroup>
    <h2>Hibernate Mapping</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>But how do you map tables to classes?</li>
<li>Hibernate offers a solution based on XML configuration files (yuck)

<ul>
<li>There is a global configuration object</li>
<li>The configuration object creates the session factory</li>
<li>The session factory then creates one or more sessions</li>
</ul></li>
<li>Hibernate also offers an easier way using Java annotations (yeay!)</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-102" style="background:;">
  <hgroup>
    <h2>Hibernate Mappings with Annotations</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>@Entity        // Maps to table called &quot;FACULTY&quot;
public class Faculty
{
    private Long fid;

    // Marks the field that corresponds to a key
    @Id @GeneratedValue  
    public Long getFid() { return fid; }
    public void setFid(Long fid) { this.fid = fid; }

    // Automatically maps to column called &quot;fname&quot;
    private String fname;
    public String getFname () { return fname; }
    public void setFname (String fname) { 
        this.fname = fname; 
    }
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-103" style="background:;">
  <hgroup>
    <h2>Hibernate Mappings with Annotations</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>    // Automatically maps to column called &quot;specialty&quot;
    private String specialty;
    public String getSpecialty () { return specialty; }
    public void setSpecialty (String specialty) { 
        this.specialty = specialty; 
    }

    // Maps to FK on Student(advisor) =&gt; Faculty(fid)
    private Set&lt;Student&gt; advisees = new HashSet&lt;Student&gt; ();

    @OneToMany(mappedBy=&quot;advisor&quot;)
    public Set&lt;Student&gt; getAdvisees() { 
        return advisees;
    }
}
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-104" style="background:;">
  <hgroup>
    <h2>Hibernate Mappings with Annotations</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>@Entity        // Maps to table called &quot;FACULTY&quot;
@Table(name=&quot;STUDENTS&quot;)
public class Student
{
    private Long sid;

    // Marks the field that corresponds to a key
    @Id @GeneratedValue  
    public Long getSid() { return sid; }
    public void setSid(Long sid) { this.sid = sid; }

    // Automatically maps to column called &quot;sname&quot;
    private String sname;
    public String getSname () { return sname; }
    public void setSname (String sname) { 
        this.sname = sname; 
    }
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-105" style="background:;">
  <hgroup>
    <h2>Hibernate Mappings with Annotations</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>    // Automatically maps to column called &quot;gpa&quot;
    private Float gpa;
    public Float getGpa () { return gpa; }
    public void setGpa (Float gpa) { 
        this.gpa = gpa; 
    }

    private Faculty advisor;
    @ManyToOne
    public Faculty getAdvisor () { return advisor; }
    public void setAdvisor (Faculty advisor) { 
        this.advisor = advisor; 
    }
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-106" style="background:;">
  <hgroup>
    <h2>Hibernate Mappings with Annotations</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>Faculty f = ...;
for (Student advisee: f.getAdvisees()) {
    // Send reminder to advisee
}
</code></pre>

<p><br></p>

<pre><code>Faculty f = ...;
Student s = ...;
s.setAdvisor (f);
session.save (s);
session.getTransaction().commit();
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-107" style="background:;">
  <hgroup>
    <h2>ORM Gotchas</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>ORMs feel very natural to most programmers</li>
<li>Many OO programmers write their own wrapper classes around a database table

<ul>
<li>I.e., they write their own ORM ... even if they don&#39;t know what an ORM is</li>
</ul></li>
<li>The problem is that writing an efficient ORM is very difficult</li>
<li>And sometimes, an efficient ORM leads to some subtle interactions</li>
<li>Hibernate also offers an easier way using Java annotations</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-108" style="background:;">
  <hgroup>
    <h2>ORM Gotchas</h2>
  </hgroup>
  <article data-timings="">
    <pre><code>Faculty f = ...;
for (Student student : f.getAdvisees ()) {
    System.out.println (student.getSname());
}
</code></pre>

<ul>
<li>How many database calls does this make?

<ul>
<li>Best case: one, joining Faculty and Students</li>
<li>Worst case: one for the student IDs, then one for each student!</li>
</ul></li>
<li>This is called the <strong>N+1</strong> problem</li>
<li>A good ORM can solve it by <strong>caching</strong> and <strong>prefetching</strong> the associated tables

<ul>
<li>What if you don&#39;t want to prefetch the student details?</li>
<li>What if a student was loaded separately?</li>
<li>What if a record is changed?</li>
<li>What if you run out of memory?</li>
</ul></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

<slide class="" id="slide-109" style="background:;">
  <hgroup>
    <h2>ORM Gotchas</h2>
  </hgroup>
  <article data-timings="">
    <ul>
<li>Writing a good ORM is extremely difficult</li>
<li>A lot has to happen on the back end to make ORMs efficient</li>
<li>Sun got it completely wrong in J2EE&#39;s EJB v. 1.0

<ul>
<li>EJB v. 2.0 fixed some of the problems, but was very complicated</li>
<li>EJB v. 3.0 is essentially Hibernate</li>
</ul></li>
<li>Don&#39;t ever try to build your own ORM unless you plan to spend a lot of time on it</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>

    <slide class="backdrop"></slide>
  </slides>
  <div class="pagination pagination-small" id='io2012-ptoc' style="display:none;">
    <ul>
      <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=1 title=''>
         1
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=2 title='The Three-Tier Architecture'>
         2
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=3 title='The Three-Tier Architecture'>
         3
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=4 title='The Three-Tier Architecture'>
         4
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=5 title='The Web Server Tier'>
         5
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=6 title='The Application Tier'>
         6
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=7 title='The Database Tier'>
         7
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=8 title='The SQL Environment'>
         8
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=9 title='The SQL Environment'>
         9
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=10 title='Components of a SQL Environment'>
         10
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=11 title='Schemas'>
         11
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=12 title='Catalogs'>
         12
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=13 title='Database Processes'>
         13
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=14 title='Connections'>
         14
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=15 title='Database Sessions'>
         15
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=16 title='SQL Modules'>
         16
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=17 title='The SQL/Host Language Interface'>
         17
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=18 title='The SQL/Host Language Interface'>
         18
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=19 title='The SQL/Host Language Interface'>
         19
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=20 title='The Impedance Mismatch'>
         20
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=21 title='Embedded SQL'>
         21
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=22 title='Embedded SQL Concepts'>
         22
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=23 title='SQLSTATE'>
         23
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=24 title='Cursors'>
         24
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=25 title='Cursors'>
         25
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=26 title='Using Cursors'>
         26
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=27 title='Using Cursors'>
         27
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=28 title='Using Cursors'>
         28
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=29 title='Modifying Rows'>
         29
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=30 title='Modifying Rows'>
         30
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=31 title='Dynamic SQL'>
         31
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=32 title='Using Cursors'>
         32
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=33 title='Using Cursors'>
         33
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=34 title='Stored Procedures'>
         34
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=35 title='Stored Procedures and Functions'>
         35
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=36 title='Stored Procedures and Functions'>
         36
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=37 title='Stored Procedures and Functions'>
         37
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=38 title='Procedural Extensions'>
         38
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=39 title='Variables'>
         39
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=40 title='Conditional Statements'>
         40
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=41 title='Loops'>
         41
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=42 title='Loops and Cursors'>
         42
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=43 title='Loops and Cursors'>
         43
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=44 title='Loops and Cursors'>
         44
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=45 title='Loops and Cursors'>
         45
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=46 title='FOR Loops'>
         46
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=47 title='FOR Loops'>
         47
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=48 title='WHILE Loops'>
         48
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=49 title='REPEAT Loops'>
         49
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=50 title='Exceptions'>
         50
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=51 title='Exceptions'>
         51
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=52 title='Exceptions'>
         52
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=53 title='Call-Level Interface'>
         53
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=54 title='Call-Level Interface'>
         54
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=55 title='JDBC'>
         55
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=56 title='JDBC Architecture'>
         56
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=57 title='Basic JDBC Application'>
         57
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=58 title='DriverManager'>
         58
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=59 title='JDBC Sessions and Connections'>
         59
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=60 title='Starting a Connection'>
         60
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=61 title='Connection Configuration'>
         61
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=62 title='Aside: Dependency Injection'>
         62
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=63 title='Aside: Dependency Injection'>
         63
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=64 title='Aside: Dependency Injection'>
         64
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=65 title='Connection API'>
         65
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=66 title='Executing SQL Statements'>
         66
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=67 title='Executing SQL Statements'>
         67
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=68 title='Getting Results Back'>
         68
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=69 title='ResultSet'>
         69
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=70 title='SQL/Java Data Types'>
         70
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=71 title='Dealing with SQL NULL Values'>
         71
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=72 title='SQL Injection'>
         72
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=73 title='SQL Injection'>
         73
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=74 title='SQL Injection'>
         74
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=75 title='SQL Injection'>
         75
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=76 title='Handling Exceptions'>
         76
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=77 title='Handling Exceptions'>
         77
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=78 title='Handling Exceptions'>
         78
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=79 title='Handling Exceptions'>
         79
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=80 title='Database Metadata'>
         80
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=81 title='Database Metadata'>
         81
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=82 title='ResultSet Metadata'>
         82
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=83 title='Template for Executing Queries'>
         83
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=84 title='Template for Executing Queries'>
         84
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=85 title='Template for Executing Queries'>
         85
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=86 title='Spring Database Templates'>
         86
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=87 title='Spring Database Templates'>
         87
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=88 title='Specifying the Database'>
         88
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=89 title='Data Access Objects'>
         89
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=90 title='Writing a DAO'>
         90
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=91 title='Writing a DAO'>
         91
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=92 title='Writing a DAO'>
         92
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=93 title='SQLJ'>
         93
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=94 title='SQLJ'>
         94
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=95 title='SQLJ'>
         95
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=96 title='SQLJ Iterators'>
         96
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=97 title='Object-Relational Mappers (ORMs)'>
         97
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=98 title='Object-Relational Mappers (ORMs)'>
         98
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=99 title='Hibernate Example'>
         99
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=100 title='Hibernate Example'>
         100
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=101 title='Hibernate Mapping'>
         101
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=102 title='Hibernate Mappings with Annotations'>
         102
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=103 title='Hibernate Mappings with Annotations'>
         103
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=104 title='Hibernate Mappings with Annotations'>
         104
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=105 title='Hibernate Mappings with Annotations'>
         105
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=106 title='Hibernate Mappings with Annotations'>
         106
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=107 title='ORM Gotchas'>
         107
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=108 title='ORM Gotchas'>
         108
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=109 title='ORM Gotchas'>
         109
      </a>
    </li>
  </ul>
  </div>  <!--[if IE]>
    <script 
      src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js">  
    </script>
    <script>CFInstall.check({mode: 'overlay'});</script>
  <![endif]-->
</body>
  <!-- Load Javascripts for Widgets -->
  <script src="libraries/widgets/bootstrap/js/bootstrap.min.js"></script>
<script src="libraries/widgets/bootstrap/js/bootbox.min.js"></script>

  <!-- MathJax: Fall back to local if CDN offline but local image fonts are not supported (saves >100MB) -->
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true
      }
    });
  </script>
  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/2.0-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <!-- <script src="https://c328740.ssl.cf1.rackcdn.com/mathjax/2.0-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script> -->
  <script>window.MathJax || document.write('<script type="text/x-mathjax-config">MathJax.Hub.Config({"HTML-CSS":{imageFont:null}});<\/script><script src="libraries/widgets/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"><\/script>')
</script>
<script>  
  $(function (){ 
    $("#example").popover(); 
    $("[rel='tooltip']").tooltip(); 
  });  
  </script>  
  <!-- LOAD HIGHLIGHTER JS FILES -->
  <script src="libraries/highlighters/highlight.js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <!-- DONE LOADING HIGHLIGHTER JS FILES -->
   
  </html>